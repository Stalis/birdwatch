stages:
  - sync
  - lint
  - test
  - build
  - deploy

default:
  image: golang:1.16

lint:
  image: golangci/golangci-lint:v1.45
  stage: lint
  script:
    - golangci-lint run --build-tags "$(go env GOOS)" ./...

vet:
  stage: lint
  script:
    - go mod tidy
    - go vet ./...

test:
  stage: test
  script:
    - go get gotest.tools/gotestsum
    - go mod tidy
    - gotestsum --junitfile report.xml --format testname -- -race ./...
  artifacts:
    when: always
    reports:
      junit: report.xml

build:
  stage: build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - when: never
  trigger:
    include: .gitlab-ci.build.yml
    strategy: depend
